---
title: "FATES post-processing script"
author: "Marcos Longo"
output:
  html_document:
    df_print: paged
---

This script creates a basic set of output figures for FATES simulations at a single site.  Most of the settings are done in the initial block.

# Initial settings


Reset session:
```{r echo=FALSE}
rm(list=ls())
options(warn=0)
graphics.off()
gc()
```

Set paths and initial variables.
```{r}
home.path  = path.expand("~")
e3sm.root  = file.path(home.path,"Documents/LocalData/E3SM-FATES/Simulations") # Current directory.
simul      = "F0001_HelloWorld"                                # File label for current simulation.
simul.desc = "F0001 (Hello World)"                             # Current simulation description.
simul.root = file.path(e3sm.root,simul,"run")                  # Main simulation path.
srcdir     = file.path(home.path,"Util/RUtils")                # Path with additional scripts.
plot.root  = file.path(simul.root,paste0(simul,"_figures"))    # Directory for figures.

whena      = "01/01/2001" # First time
whenz      = "12/01/2010" # Last time


# Output path for time series
tspoi.path    = file.path(plot.root,"tseries_poi"  )
tstheme.path  = file.path(plot.root,"tseries_theme")
tsage.path    = file.path(plot.root,"tseries_age"  )
tsdbh.path    = file.path(plot.root,"tseries_dbh"  )

# Create output paths
dummy      = dir.create(tspoi.path  ,recursive = TRUE,showWarnings = FALSE)
dummy      = dir.create(tstheme.path,recursive = TRUE,showWarnings = FALSE)
dummy      = dir.create(tsage.path  ,recursive = TRUE,showWarnings = FALSE)
dummy      = dir.create(tsdbh.path  ,recursive = TRUE,showWarnings = FALSE)


```

Plot options
```{r}
gg.device  = c("pdf") # Output devices to use (Check ggsave for acceptable formats)
gg.depth   = 300      # Plot resolution (dpi)
gg.ptsz    = 18       # Font size
gg.width   = 8.5      # Plot width (units below)
gg.height  = 8.5      # Plot height (units below)
gg.units   = "in"     # Units for plot size
gg.screen  = TRUE     # Show plots on screen as well?
gg.tfmt    = "%Y"     # Format for time 

ndevice = length(gg.device)
```

# Main script

__Note:__ Changes beyond this point are only needed if you are developing the notebook.

Load packages and tools
```{r}
source(file.path(srcdir,"load.everything.r"))
isok = require(ncdf4)
if (! isok) stop("This script requires package \"ncdf4\".")
```


Initial settings.
```{r}

#--- Convert strings to dates.
whena  = chron(whena)
whenz  = chron(whenz)
montha = nummonths(whena)
yeara  = numyears(whena)
monthz = nummonths(whenz)
yearz  = numyears(whenz)
nyears = yearz-yeara
#---~---


#--- Build time series.
if (yeara == yearz){
  when = chron(paste(seq(from=montha,to=monthz,by=1)),1,yeara,sep="/")
}else{
  when = c( chron(paste(seq(from=montha,to=12,by=1),1,yeara,sep="/"))
          , chron(paste( rep(seq(from=1,to=12,by=1),times=nyears-1)
                       , 1
                       , rep(seq(from=yeara+1,to=yearz-1,by=1),each=12)
                       , sep="/"
                       )#end paste
                 )#end chron
          , chron(paste(seq(from=1,to=monthz,by=1),1,yearz,sep="/"))
          )#end c  
}#end if (yeara == yearz)
#---~---


#--- Number of times
nwhen = length(when)
#---~---

```


Loop through the times, and load the data sets.

```{r}
first = TRUE
if ("nc.conn" %in% ls()){dummy = nc_close(nc.conn); rm(nc.conn)}
for (w in sequence(nwhen)){
  #--- Extract times and build file name
  w.month = nummonths(when[w])
  w.year  = numyears (when[w])
  w.ymlab = sprintf("%4.4i-%2.2i",w.year,w.month)
  nc.base = paste0(simul,".elm.h0.",w.ymlab,".nc")
  nc.file = file.path(simul.root,nc.base)
  cat0(" + Read data from file ",nc.base,".")
  #---~---

  #--- Open NetCDF connection and retrieve variable names
  nc.conn  = nc_open(filename=nc.file)
  nc.nvars = nc.conn$nvars
  nc.ndims = nc.conn$ndims
  nc.dlist = rep(NA_character_,times=nc.ndims)
  nc.vlist = rep(NA_character_,times=nc.nvars)
  for (d in sequence(nc.ndims)) nc.dlist[d] = nc.conn$dim[[d]]$name
  for (v in sequence(nc.nvars)) nc.vlist[v] = nc.conn$var[[v]]$name
  #---~---


    
  #--- If this is the first time, initialise matrices
  if (first){
    #--- List of age classes
    idxage   = match("fates_levage",nc.dlist)
    ages     = nc.conn$dim[[idxage]]$vals
    nages    = nc.conn$dim[[idxage]]$len
    agekeys  = sprintf("age.%3.3i",ages)
    agelabs  = c( paste0("paste(",ages[-nages],"-",ages[-1],")")
                , paste0("paste(",ages[nages],"-infinity)")
                )#end c
    agelabs  = parse(text=agelabs)
    #---~---

    #--- List of size classes
    idxdbh   = match("fates_levscls",nc.dlist)
    dbhs     = nc.conn$dim[[idxdbh]]$vals
    ndbhs    = nc.conn$dim[[idxdbh]]$len
    dbhkeys  = sprintf("dbh.%3.3i",dbhs)
    dbhlabs  = c( paste0("paste(",dbhs[-ndbhs],"-",dbhs[-1],")")
                , paste0("paste(",dbhs[ndbhs],"-infinity)")
                )#end dbhlabs
    dbhlabs  = parse(text=dbhlabs)
    #---~---
    
    #--- Retrieve all variables by age class.
    nc.byage = nc.vlist[grepl(pattern="_BY_AGE$",x=nc.vlist)]
    nc.pref  = tolower(gsub(pattern="_BY_AGE$",replacement="",x=nc.byage))
    nc.keep  = nc.pref %in% fatesvar$vnam
    no.byage = nc.byage[! nc.keep]
    nc.byage = nc.byage[  nc.keep]
    nbyage   = length(nc.byage)
    #---~---

    #--- Retrieve all variables by size class.
    nc.bydbh  = nc.vlist[grepl(pattern="_SCLS$",x=nc.vlist)]
    nc.pref   = tolower(gsub(pattern="_SCLS$",replacement="",x=nc.bydbh))
    nc.keep   = nc.pref %in% fatesvar$vnam
    no.bydbh  = nc.bydbh[! nc.keep]
    nc.bydbh  = nc.bydbh[  nc.keep]
    nbydbh    = length(nc.bydbh)
    #---~---

    #--- Retrieve all "1D" variables that are available at the host model.
    nc.pref   = tolower(x=nc.vlist)
    nc.keep   = nc.pref %in% hlm1dvar$vnam
    no.hlm1d  = nc.vlist[! nc.keep]
    nc.hlm1d  = nc.vlist[  nc.keep]
    nhlm1d    = length(nc.hlm1d)
    #---~---


    #--- Initialise list of variables by age class.
    byage  = list()
    for (a in sequence(nbyage)){
      nc.nvnow        = nc.byage[a]
      nc.pref         = tolower(gsub(pattern="_BY_AGE$",replacement="",x=nc.nvnow))
      f               = match(nc.pref,fatesvar$vnam)
      f.vnam          = fatesvar$vnam[f]
      byage[[f.vnam]] = matrix(data=NA_real_,nrow=nwhen,ncol=nages,dimnames=list(NULL,agekeys))
    }#end for (a in sequence(nbyage))
    #---~---

    #--- Initialise list of variables by size class
    bydbh = list()
    for (d in sequence(nbydbh)){
      nc.nvnow        = nc.bydbh[d]
      nc.pref         = tolower(gsub(pattern="_SCLS$",replacement="",x=nc.nvnow))
      f               = match(nc.pref,fatesvar$vnam)
      f.vnam          = fatesvar$vnam[f]
      bydbh[[f.vnam]] = matrix(data=NA_real_,nrow=nwhen,ncol=ndbhs,dimnames=list(NULL,dbhkeys))
    }#end for (d in sequence(nbydbh))
    #---~---

    #--- Initialise 1D variables available at the HLM
    hlm1d = as.data.table( matrix( data     = NA_real_
                                 , nrow     = nwhen
                                 , ncol     = nhlm1d
                                 , dimnames = list(NULL,tolower(nc.hlm1d))
                                 )#end matrix
                         )#end as.data.table
    #---~---


    #--- Switch flag to FALSE so the lists are not rewritten.
    first   = FALSE
    #---~---
  }#end if (first)
  #---~---

  #--- Read variables by age, and assign current values to the matrix  
  for (a in sequence(nbyage)){
      nc.nvnow            = nc.byage[a]
      nc.pref             = tolower(gsub(pattern="_BY_AGE$",replacement="",x=nc.nvnow))
      f                   = match(nc.pref,fatesvar$vnam)
      f.vnam              = fatesvar$vnam[f]
      f.add0              = eval(parse(text=fatesvar$add0[f]))
      f.mult              = eval(parse(text=fatesvar$mult[f]))
      nc.dat              = ncvar_get(nc=nc.conn,varid=nc.nvnow)
      byage[[f.vnam]][w,] = f.add0 + f.mult * nc.dat
  }#for (a in sequence(nbyage))
  #---~---

  #--- Read variables by size, and assign current values to the matrix  
  for (d in sequence(nbydbh)){
      nc.nvnow            = nc.bydbh[d]
      nc.pref             = tolower(gsub(pattern="_SCLS$",replacement="",x=nc.nvnow))
      f                   = match(nc.pref,fatesvar$vnam)
      f.vnam              = fatesvar$vnam[f]
      f.add0              = eval(parse(text=fatesvar$add0[f]))
      f.mult              = eval(parse(text=fatesvar$mult[f]))
      nc.dat              = ncvar_get(nc=nc.conn,varid=nc.nvnow)
      bydbh[[f.vnam]][w,] = f.add0 + f.mult * nc.dat
  }#for (d in sequence(nbydbh))
  #---~---

  #--- Read 1D variables  
  for (v in sequence(nhlm1d)){
      nc.nvnow            = nc.hlm1d[v]
      nc.pref             = tolower(x=nc.nvnow)
      h                   = match(nc.pref,hlm1dvar$vnam)
      h.vnam              = hlm1dvar$vnam[h]
      h.add0              = eval(parse(text=hlm1dvar$add0[h]))
      h.mult              = eval(parse(text=hlm1dvar$mult[h]))
      nc.dat              = ncvar_get(nc=nc.conn,varid=nc.nvnow)
      hlm1d[[h.vnam]][w]  = h.add0 + h.mult * nc.dat
  }#for (h in sequence(nhlm1d))
  #---~---

  # Close connection
  dummy   = nc_close(nc.conn)
  
}#end for (w in sequence(nwhen))




```

Turn data matrices into molten data tables (preferred data structure for plotting and analysing).
```{r}

#--- Turn age-dependent matrices into data tables
cat0(" + Turn age-dependent matrices into data tables.")
age.melt = NULL
for (a in sequence(nbyage)){
  #--- Match variables.
  f        = match(names(byage)[a],fatesvar$vnam)
  f.vnam   = fatesvar$vnam[f]
  f.desc   = fatesvar$desc[f]
  cat0("   - ",f.desc,".")
  #---~---

  #--- Create molten data table for this variable.  
  now.age      = as.data.table(byage[[f.vnam]])
  now.age$when = chron(when)
  now.melt     = data.table(melt(data=now.age,id.vars="when",variable.name="age",value.name=f.vnam))
  #---~---

  #--- Merge data table
  if (is.null(age.melt)){
    age.melt = now.melt
  }else{
    age.melt = merge(x=age.melt,y=now.melt,by=c("when","age"),all=TRUE)
  }#end if (is.null(age.melt))
  #---~---
}#end for (a in sequence(nbyage))
#---~---

#--- Turn size-dependent matrices into data tables
cat0(" + Turn size-dependent matrices into data tables.")
dbh.melt = NULL
for (d in sequence(nbydbh)){
  #--- Match variables.
  f        = match(names(bydbh)[d],fatesvar$vnam)
  f.vnam   = fatesvar$vnam[f]
  f.desc   = fatesvar$desc[f]
  cat0("   - ",f.desc,".")
  #---~---

  #--- Create molten data table for this variable.  
  now.dbh      = as.data.table(bydbh[[d]])
  now.dbh$when = chron(when)
  now.melt     = data.table(melt(data=now.dbh,id.vars="when",variable.name="dbh",value.name=f.vnam))
  #---~---

  #--- Merge data table
  if (is.null(dbh.melt)){
    dbh.melt = now.melt
  }else{
    dbh.melt = merge(x=dbh.melt,y=now.melt,by=c("when","dbh"),all=TRUE)
  }#end if (is.null(scls.melt))
  #---~---
}#end for (d in sequence(nbydbh))
#---~---

#--- Remove data that are not molten.
byage = age.melt
bydbh = dbh.melt
rm(age.melt,dbh.melt)
#---~---

#--- Convert dbh and age classes into integers
cat0(" + Convert classes to integers.")
byage$age = as.numeric(byage$age)
bydbh$dbh = as.numeric(bydbh$dbh)
#---~---

```



Plot time series by age:
```{r}
cat0(" + Plot time series of age-dependent variables.")

#--- Title for legend
age.legend = desc.unit(desc="Age",unit=untab$yr)
#---~---

age.loop   = which(fatesvar$vnam %in% names(byage))
gg.age   = list()
for (f in age.loop){
  #--- Match variables.
  f.vnam   = fatesvar$vnam [f]
  f.desc   = fatesvar$desc [f]
  f.unit   = fatesvar$unit [f]
  f.stack  = fatesvar$stack[f]
  cat0("   - ",f.desc,".")
  #---~---
  
  #--- Temporary data table. We convert the classes back to factor.
  f.byage     = byage
  f.byage$age = factor(f.byage$age,levels=sequence(nages))
  f.colages   = viridis(nages,option="D",direction=-1)
  f.agelabs   = agelabs
  #---~---
  
  #--- Initialise plot (decide whether to plot lines or stacks).
  if (f.stack){
     gg.now = ggplot(data=f.byage,aes_string(x="when",y=f.vnam,group="age",fill="age"))
     gg.now = gg.now + scale_fill_manual(name=age.legend,labels=f.agelabs,values=f.colages)
     gg.now = gg.now + geom_area(position="stack",show.legend = TRUE)
  }else{
     gg.now = ggplot(data=f.byage,aes_string(x="when",y=f.vnam,group="age",colour="age"))
     gg.now = gg.now + scale_colour_manual(name=age.legend,labels=f.agelabs,values=f.colages)
     gg.now = gg.now + geom_line(lwd=1.0,show.legend = TRUE)
  }#end if (f.stack)
  gg.now = gg.now + labs(title=simul.desc)
  gg.now = gg.now + scale_x_chron(format=gg.tfmt)
  gg.now = gg.now + xlab("Simulation time")
  gg.now = gg.now + ylab(desc.unit(desc=f.desc,unit=untab[[f.unit]]))
  gg.now = gg.now + theme_grey( base_size = gg.ptsz, base_family = "Helvetica",base_line_size = 0.5,base_rect_size =0.5)
  gg.now = gg.now + theme( legend.position   = "bottom"
                         , axis.text.x       = element_text( size   = gg.ptsz
                                                           , margin = unit(rep(0.35,times=4),"cm")
                                                           )#end element_text
                         , axis.text.y       = element_text( size   = gg.ptsz
                                                           , margin = unit(rep(0.35,times=4),"cm")
                                                           )#end element_text
                         , axis.ticks.length = unit(-0.25,"cm")
                         )#end theme
  #---~---
  
  #--- Save plot.
  for (d in sequence(ndevice)){
    f.output = paste0(f.vnam,"-tsage-",simul,".",gg.device[d])
    dummy = ggsave( filename = f.output
                  , plot     = gg.now
                  , device   = gg.device[d]
                  , path     = tsage.path
                  , width    = gg.width
                  , height   = gg.height
                  , units    = gg.units
                  , dpi      = gg.depth
                  )#end ggsave
  }#end for (o in sequence(nout))
  #---~---

  #--- Write plot settings to the list.
  gg.age[[f.vnam]] = gg.now
  #---~---
}#end for (a in age.loop)


#--- If sought, plot images on screen
if (gg.screen) gg.age
#---~---

```



Plot time series by size class:
```{r}
cat0(" + Plot time series of size-dependent variables.")

#--- Title for legend
dbh.legend = desc.unit(desc="DBH",unit=untab$cm)
#---~---

dbh.loop = which(fatesvar$vnam %in% names(bydbh))
gg.dbh   = list()
for (f in dbh.loop){
  #--- Match variables.
  f.vnam   = fatesvar$vnam [f]
  f.desc   = fatesvar$desc [f]
  f.unit   = fatesvar$unit [f]
  f.stack  = fatesvar$stack[f]
  f.dbh01  = fatesvar$dbh01[f]
  cat0("   - ",f.desc,".")
  #---~---
  
  #--- Decide whether to plot the first class.
  if (f.dbh01){
    #--- Keep all classes.
    f.bydbh     = bydbh
    f.bydbh$dbh = factor(f.bydbh$dbh,levels=sequence(ndbhs))
    f.coldbhs   = magma(ndbhs,direction=1)
    f.dbhlabs   = dbhlabs
    #---~---
  }else{
    #--- Exclude first class.
    bye         = as.numeric(bydbh$dbh) %in% 1
    f.bydbh     = bydbh[! bye,]
    f.bydbh$dbh = factor(f.bydbh$dbh,levels=sequence(ndbhs)[-1])
    f.coldbhs   = magma(ndbhs,direction=1)[-1]
    f.dbhlabs   = dbhlabs[-1]
    #---~---
  }#end if (f.dbh01)
  #---~---
   
  #--- Initialise plot (decide whether to plot lines or stacks).
  if (f.stack){
     gg.now = ggplot(data=f.bydbh,aes_string(x="when",y=f.vnam,group="dbh",fill="dbh"))
     gg.now = gg.now + scale_fill_manual(name=dbh.legend,labels=f.dbhlabs,values=f.coldbhs)
     gg.now = gg.now + geom_area(position=position_stack(reverse = TRUE),show.legend = TRUE)
  }else{
     gg.now = ggplot(data=f.bydbh,aes_string(x="when",y=f.vnam,group="dbh",colour="dbh"))
     gg.now = gg.now + scale_colour_manual(name=dbh.legend,labels=f.dbhlabs,values=f.coldbhs)
     gg.now = gg.now + geom_line(lwd=1.0,show.legend = TRUE)
  }#end if (f.stack)
  gg.now = gg.now + labs(title=simul.desc)
  gg.now = gg.now + scale_x_chron(format=gg.tfmt)
  gg.now = gg.now + xlab("Simulation time")
  gg.now = gg.now + ylab(desc.unit(desc=f.desc,unit=untab[[f.unit]]))
  gg.now = gg.now + theme_grey( base_size = gg.ptsz, base_family = "Helvetica",base_line_size = 0.5,base_rect_size =0.5)
  gg.now = gg.now + theme( legend.position   = "bottom"
                         , axis.text.x       = element_text( size   = gg.ptsz
                                                           , margin = unit(rep(0.35,times=4),"cm")
                                                           )#end element_text
                         , axis.text.y       = element_text( size   = gg.ptsz
                                                           , margin = unit(rep(0.35,times=4),"cm")
                                                           )#end element_text
                         , axis.ticks.length = unit(-0.25,"cm")
                         )#end theme
  #---~---

  #--- Save plot.
  for (d in sequence(ndevice)){
    f.output = paste0(f.vnam,"-tsdbh-",simul,".",gg.device[d])
    dummy = ggsave( filename = f.output
                  , plot     = gg.now
                  , device   = gg.device[d]
                  , path     = tsdbh.path
                  , width    = gg.width
                  , height   = gg.height
                  , units    = gg.units
                  , dpi      = gg.depth
                  )#end ggsave
  }#end for (o in sequence(nout))
  #---~---

  #--- Write plot settings to the list.
  gg.dbh[[f.vnam]] = gg.now
  #---~---
}#end for (a in age.loop)


#--- If sought, plot images on screen
if (gg.screen) gg.dbh
#---~---

```



Plot theme time series:
```{r}
cat0(" + Plot time series of thematically linked variables.")

gg.theme   = list()
for (th in sequence(ntstheme)){
  #--- Match variables.
  th.thnam  = tstheme$thnam  [th]
  th.thdesc = tstheme$thdesc [th]
  th.thunit = tstheme$thunit [th]
  th.vnames = tstheme$vnames [th]
  th.vcols  = tstheme$vcols  [th]
  th.stack  = tstheme$tsstack[th]

  #--- Split variables to include in this plot (plot only when all data are available).
  th.vlist   = c(unlist(strsplit(x=th.vnames,split="\\+")))
  th.match   = match(th.vlist,hlm1dvar$vnam)
  th.vdesc   = hlm1dvar$desc[th.match]
  th.labels  = parse(text=paste0("paste(",hlm1dvar$short[th.match],")"))
  n.th.vlist = length(th.vlist)
  #---~---

  #--- Proceed only if all variables exist in the output
  if (all(th.vlist %in% names(hlm1d))){
     #--- Title for legend
     cat0("   - ",th.thdesc,".")
     #---~---


     #--- Temporary data table. We convert the classes back to factor.
     thmelt       = hlm1d[,..th.vlist]
     thmelt$when  = chron(when)
     thmelt       = melt( data          = thmelt
                        , id.vars       = "when"
                        , variable.name = "idvar"
                        , measure.vars  = th.vlist
                        , value.name    = th.thnam
                        )#end melt
     thmelt       = data.table(thmelt)
     thmelt$idvar = factor(as.integer(thmelt$idvar))
     #---~---

       
     #--- Find colours for theme plot.
     th.funcol   = try(match.fun(th.vcols),silent=TRUE)
     if ("try-error" %in% is(th.funcol)){
       th.colour = c(unlist(strsplit(x=th.vcols,split="\\+")))
     }else{
       th.colour = th.funcol(n=n.th.vlist)
     }#end if ("try-error %in% is(th.funcol))
     #---~---
  
     
     
     #--- Initialise plot (decide whether to plot lines or stacks).
     if (th.stack){
        gg.now = ggplot(data=thmelt,aes_string(x="when",y=th.thnam,group="idvar",fill="idvar"))
        gg.now = gg.now + scale_fill_manual(name=character(0),labels=th.labels,values=th.colour)
        gg.now = gg.now + geom_area(position="stack",show.legend = TRUE)
     }else{
        gg.now = ggplot(data=thmelt,aes_string(x="when",y=th.thnam,group="idvar",colour="idvar"))
        gg.now = gg.now + scale_colour_manual(name=character(0),labels=th.labels,values=th.colour)
        gg.now = gg.now + geom_line(lwd=1.0,show.legend = TRUE)
     }#end if (f.stack)
     gg.now = gg.now + labs(title=simul.desc)
     gg.now = gg.now + scale_x_chron(format=gg.tfmt)
     gg.now = gg.now + xlab("Simulation time")
     gg.now = gg.now + ylab(desc.unit(desc=th.thdesc,unit=untab[[th.thunit]]))
     gg.now = gg.now + theme_grey( base_size      = gg.ptsz
                                 , base_family    = "Helvetica"
                                 , base_line_size = 0.5
                                 , base_rect_size = 0.5
                                 )#end theme_grey
     gg.now = gg.now + theme( legend.position   = "bottom"
                            , axis.text.x       = element_text( size   = gg.ptsz
                                                              , margin = unit(rep(0.35,times=4),"cm")
                                                              )#end element_text
                            , axis.text.y       = element_text( size   = gg.ptsz
                                                              , margin = unit(rep(0.35,times=4),"cm")
                                                              )#end element_text
                            , axis.ticks.length = unit(-0.25,"cm")
                            )#end theme
     #---~---
  
     #--- Save plot.
     for (d in sequence(ndevice)){
        th.output = paste0(th.thnam,"-tstheme-",simul,".",gg.device[d])
        dummy = ggsave( filename = th.output
                      , plot     = gg.now
                      , device   = gg.device[d]
                      , path     = tstheme.path
                      , width    = gg.width
                      , height   = gg.height
                      , units    = gg.units
                      , dpi      = gg.depth
                      )#end ggsave
     }#end for (o in sequence(nout))
     #---~---

     #--- Write plot settings to the list.
     gg.theme[[th.thnam]] = gg.now
     #---~---
    
  }#end if (all(th.vlist %in% names(hlm1d))))    
  #---~---
}#end for (a in age.loop)


#--- If sought, plot images on screen
if (gg.screen) gg.theme
#---~---

```