---
title: "Create case for ELM-FATES or CLM-FATES"
author: "Marcos Longo"
date: "31-Oct-2021"
---


# Introduction


This R Markdown script generates a case for a single-point simulation for a user-defined site.  It assumes all the site-specific data files (`site_name`) are located in the  `site_base_path` folder (see below).

This script does not take any arguments. Instead, the beginning of the script has many variables to control the simulation settings.

*Note*. This Rmd file replaces the need for a shell script; In case you prefer a shell script, check [create_case_hlm-fates.sh](https://github.com/mpaiao/FATES_Utils/blob/master/create_case_hlm-fates.sh) instead.



# Reset session

Use this chunk to fully reset R.
```{r, label = 'reset-R',message=FALSE, results='hide'}
# Unload all packages except for the R default ones
plist = names(sessionInfo()$otherPkgs)
if (length(plist) > 0){
   dummy = sapply(X=paste0("package:",plist),FUN=detach,character.only=TRUE,unload=TRUE)
}#end if (length(plist) > 0)


# Remove all variables
rm(list=ls())

# Reset warnings
options(warn=0)

# Close all plots
invisible(graphics.off())

# Clean up
invisible(gc())
```

# Main settings

## Required packages

Load some packages. By default, we skip the warning messages, but it may be a good idea to
visualise them if it is the first time running.
```{r, label='load-packages', message=FALSE, results='hide'}

isfine = c( git2r      = require(git2r     ,quietly=TRUE,warn.conflicts=FALSE)
          , lubridate  = require(lubridate ,quietly=TRUE,warn.conflicts=FALSE)
          , ncdf4      = require(ncdf4     ,quietly=TRUE,warn.conflicts=FALSE)
          , reshape2   = require(reshape2  ,quietly=TRUE,warn.conflicts=FALSE)
          , reticulate = require(reticulate,quietly=TRUE,warn.conflicts=FALSE)
          , tidyverse  = require(tidyverse ,quietly=TRUE,warn.conflicts=FALSE)
          )#end c
if (! all(isfine)){
   cat(" List of required packages, and the success status loading them:\n")
   print(isfine)
   stop(" Some packages are missing and must be installed.")
}

# Make sure there is a python environment associated with R. If not, install it (it will take a 
# while but this is only needed once).
if (! py_available()){
   py_available(TRUE)
}#end if (! py_available())

# Import python libraries (same as in modify_fates_paramfile.py). This is needed for the python
# script to run from within R/
dummy = py_install("scipy")
dummy = py_install("numpy")
```

# Main settings.

First we define which model to run and where to run:

- **hesm**. The host earth system model.  Acceptable options are `"E3SM"`, `"CESM"`, or `"CTSM"`.
- **project**. This is the project associated with the job run, mostly useful in cluster systems.
- **mach**. The machine used for preparing the case. This must be one of the supported machines, or you may want to generate specifications for your own machine. More information on how to set up the machine available [here](https://esmci.github.io/cime/versions/ufs_release_v1.0/html/users_guide/porting-cime.html).
```{r, label='main-fates-settings'}
# Main settings.
hesm    = "CTSM"        # Host "Earth System Model". (E3SM, CESM, CTSM)
project = "ngeet"       # Project (may not be needed)
mach    = "eschweilera" # Machine used for preparing the case
```

Here we set up the case handling:

- **overwrite_case**.  In case the case already exists, should the script delete the existing case and make a new one? (`TRUE` deletes old case, `FALSE` issue an error and halt script.)
- **case_submit**.  Should the R script start the job run? If `TRUE`, the script will create the case and run it; if `FALSE`, the case and simulation directories will be created, but the model will not run. You will need to go to the case directory and run `case.submit` through the terminal.
- **case_wait**. If `case_submit = TRUE`, should the R script wait until the job finishes? If `TRUE` the script will save the screen output in a local variable and will lock the terminal (or RStudio...) until the run finishes.  This may be useful only when debugging, otherwise, it makes more sense to set it to `FALSE`.

```{r, label='job-run-settings'}
# Overwrite existing case
overwrite_case = TRUE

# Should the job be submitted?
case_submit = TRUE

# Should we wait until the simulation finishes?
case_wait = FALSE
```


The settings below are useful for debugging the code:

- **debug_level**. The higher the number, the more information will be provided (at the expense of running slower).  0 means no debugging (typical setting for scientific analysis), 6 means very strict debugging (useful when developing the code).
- **use_fates**. Logical flag (`true` or `false`).  This option allows running the native  host land model (CLM or ELM) without FATES, which may be useful for some debugging.

```{r, label='debug-settings'}
debug_level = 0     # Debugging level
use_fates   = TRUE  # Use FATES (TRUE) or just the host land model (FALSE)
```

Set paths:

- **home_path**. The home directory (useful for building paths).
- **work_path**: The main working path (typically `<host_model>/cime/scripts`)
- **case_root**: The main path where to create the directory for this case.
- **simul_root**: The main path where to create the directory for the simulation output.
- **grid_base_path**: The main path with gridded input files.
- **site_base_path**: The main path with site-specific input files.

*Note*. In all cases, use `XXXX` in the part you want to be replaced with either E3SM or CTSM.
```{r, label='path-settings'}
home_path  = path.expand("~") # Home path.
work_path  = file.path(home_path,"Models","XXXX","cime","scripts")
case_root  = file.path(home_path,"Documents","LocalData","FATES","SingleRuns","Cases")
simul_root = file.path(home_path,"Documents","LocalData","FATES","SingleRuns","Simulations")

# Paths containing data sets.
grid_base_path = file.path(home_path,"Documents","LocalData","FATES","InputData") # Gridded data
site_base_path = file.path(home_path,"Data","FATES_DataSets")                     # Site-specific data
```



Assign the compilation settings.  It is fine to leave this blank, in which case the script will use default settings.
```{r, label='comp-settings'}
comp      = ""
```


Set the grid resolution (variable `resol`). This must be a standard ELM/CLM grid resolution. In case you want to use the site information, set `resol="YYY_USRDAT"`.  The host model will be replaced later in the script.
```{r, label='set-grid-resol'}
resol = "YYY_USRDAT" # Grid resolution
```

The following chunk contains variables that will pick the site (in case `resol="YYY_USRDAT"`), and help setting the case name (regardless of the site). If this is not a single-site run, most of these settings will be ignored. Most information comes from `site_info`, a tibble object with the following variables:

* **site_id**. A unique site id.  Typically a sequential order (but the code checks it.)
* **case**.  A short name for the site, which can be used for defining a case name, for example (see below).
* **ei64_name**. The full site name, typically the sub-directory where all the site-specific data are stored. 
* **start_date**. The start date for simulating the site. Useful if running FATES over site-specific time periods (e.g. tower data overlap).
* **stop_n**. Number of years to run the model for this site.  Useful if running FATES over site-specific time periods (e.g. tower data overlap).
* **datm_first**. First year with meteorological driver. This is normally fixed unless new versions of the data become available.
* **datm_last**. Last year with meteorological driver. This is normally fixed unless new versions of the data become available.
* **calendar**. Which calendar type should we use? This must be consistent with the meteorological drivers. Options are `"NO_LEAP"`, for non-leap years and `"GREGORIAN"`, for Gregorian calendar. Note that `"GREGORIAN"` calendar requires meteorological drivers that extend to entire simulation time span (i.e., no recycling), otherwise, the simulation will likely crash in one of the Februaries outside the meteorological driver range.
* **inv_suffix**. Suffix for the forest inventory plot initialisation instructions.  The base file name with instructions should be like: `<site_name>_<inv_suffix>.txt`.  In case you do not want to use inventory initialisation, leave this blank (`""`).
* **parameter_set**. Base name of the file containing the model parameters. In case none is available, set this to blank (`""`).

Variable `site_use` lets you pick which site to use. This is an integer variable that must correspond to one of the `site_id` listed in `site_info`. Last, you must define a base directory (`site_base_path`).  If using a standard data file structure, this is the directory where all site data are located, one sub-directory per site. The names of these sub-directories match `site_name`. Each site-specific path (i.e. `<site_base_path>/<site_name>should contain:

1. A sub-directory `CLM1PT` containing the meteorological drivers.  Check documentation for script [make_fates_met_driver.Rmd](make_fates_met_driver.html) for more details.
2. The domain and surface data specific for this site. Check documentation for script [make_fates_domain+surface.Rmd](make_fates_domain+surface.html) for further information.
3. _Optional_. A FATES parameter file. This file is assumed to be in the `<site_name>` sub-directory.  In case none is provided (i.e., `<parameter_set>=""`), the case will use the default parameter file. Beware that the default is not optimised and may yield bad results.
4. _Optional_. The forest structure control data, which should contain the full paths to ED2-style  pss (patch) and css (cohort) files. This file base name should be `<site_name>_<inv_suffix>.txt`, or blank in case inventories should not be used.  Check the [ED2 Wiki](https://github.com/EDmodel/ED2/wiki/Initial-conditions) for details on how to generate the files.

The actual scripts are available on [GitHub](https://github.com/mpaiao/ED2_Support_Files/tree/master/pss%2Bcss_processing).

```{r, label='site-list'}
site_info = tidyr::tribble( ~site_id, ~case               , ~site_name                           ,   ~start_date,          ~stop_n,  ~datm_first, ~datm_last
                                    , ~calendar           ,~parameter_set                                       ,      ~inv_suffix
                          ,        0, "ParacouTest"       , "1x1pt-paracouGUF_v1.6_c20210913"    ,  "2004-01-01",                4,         2004,       2019
                                    , "NO_LEAP"           , "fates_params_2trop_koven_opt224+api16_c210722.cdl" , "nopft_info"
                          ,        1, "ParacouNewPhen"    , "1x1pt-paracouGUF_v1.6_c20210913"    ,  "2004-01-01",               16,         2004,       2019
                                    , "NO_LEAP"           , "fates_params_2trop_koven_opt224+api16_c210722.cdl" , "nopft_info"
                          ,        2, "TanguroNewPhen"    , "1x1pt-tanguroMT-BR_v1.2_c20210913"  ,  "2008-01-01",               12,         2008,       2018
                                    , "NO_LEAP"           , "fates_params_2trop_koven_opt224+api16_c210722.cdl" , "nopft_info"
                          ,        3, "PetrolinaNewPhen"  , "1x1pt-petrolinaPE-BR_v1.2_c20210913",  "2004-01-01",               12,         2004,       2012
                                    , "NO_LEAP"           , "fates_params_2trop_koven_opt224+api16_c210722.cdl" , "nopft_info"
                          ,        4, "ParacouEvergreen"  , "1x1pt-paracouGUF_v1.6_c20210913"    ,  "2004-01-01",               16,         2004,       2019
                                    , "NO_LEAP"           , "fates_params_2trop_koven_opt224+api16_c210722.cdl" , "evergreen_info"
                          ,        5, "TanguroEvergreen"  , "1x1pt-tanguroMT-BR_v1.2_c20210913"  ,  "2008-01-01",               12,         2008,       2018
                                    , "NO_LEAP"           , "fates_params_2trop_koven_opt224+api16_c210722.cdl" , "evergreen_info"
                          ,        6, "PetrolinaEvergreen", "1x1pt-petrolinaPE-BR_v1.2_c20210913",  "2004-01-01",               12,         2004,       2012
                                    , "NO_LEAP"           , "fates_params_2trop_koven_opt224+api16_c210722.cdl" , "evergreen_info"
                          )#end tidyr::tribble

# Select ID from above to decide which site to pick
site_use = 0


#---~---
# Derived settings. No need to change these unless you are using non-standard settings.
#---~---
# isite will take the correct line (in case site_id is not in sequential order). 
isite    = match(site_use,site_info$site_id)
# Sub-directory with data sets specific to this site.
site_name = site_info$site_name[isite]
# Domain file (it must be in the SITE_NAME sub-directory).
hlm_usrdat_domain = paste0("domain.lnd.",site_name,"_navy.nc")
# Surface data file (it must be in the SITE_NAME sub-directory).
hlm_usrdat_surdat = paste0("surfdata_",site_name,".nc")
# Calendar type for the meteorological drivers ('NO_LEAP' or 'GREGORIAN'). 'NO_LEAP' is strongly encouraged.
metd_calendar = site_info$calendar[isite]
# Parameter file, in case a site-specific file exists. Leave it blank for using the
# default parameter file. 
fates_params_base = site_info$parameter_set[isite]
# Control file with information on which patch (pss) and cohort (css) file to use (or blank for no inventory initialisation).
inventory_base = if(site_info$inv_suffix[isite] %in% ""){""}else{paste0(site_name,"_",site_info$inv_suffix[isite],".txt")}
```

The following variables will help to create the case name.



#Select suffix to describe the simulation (it may be used for building the case name.
case_suffix = "NewPhen"

* **case_prefix**. The case name prefix, if this variable is a valid, non-empty character. Alternatively, if you want the case name to be defined automatically, leave this variable blank.  Feel free to use site-specific variables from the previous chunk.
* **append_git_hash**. This decides whether (`TRUE`) or not (`FALSE`) to append the current git commit hash to the case names. Appending the hash can be useful for reproducibility and is encouraged for scientific work.  If just testing or debugging the code, setting it to false makes the case name shorter and more friendly.
Assign the case name. It is fine to leave this blank, although the name may be less descriptive.

```{r, label='case-name-settings'}
# Set case name prefix (set it to "" for default case name).
case_prefix     = paste0("S",sprintf("%4.4i",site_use),"_",site_info$case[isite])
# Should the case name contain the Git hash?
append_git_hash = FALSE

```
`

The variable below lists all quantities to be updated using the `xmlchange` functionality of CIME.

- In case you do not want to change any settings, set the variable as an empty object (i.e., `xml_settings=NULL`).
- Otherwise, create a tribble object with two string columns, namely `variable` and `value`.  For string values, make sure to enclose it in single quotes when needed.  If you want, you can use the generic wildcard YYY for variables that may be either CLM or ELM (lower case yyy will replace with the lower-case model name).  The code will interpret it accordingly.

```{r, label='xml-settings'}
xml_settings = tidyr::tribble( ~variable               , ~value
                             , "DEBUG"                 , "FALSE"
                             , "RUN_STARTDATE"         , site_info$start_date[isite]
                             , "STOP_N"                , as.character(site_info$stop_n[isite])
                             , "STOP_OPTION"           , "nyears"
                             , "REST_N"                , "1"
                             , "YYY_FORCE_COLDSTART"   , "on"
                             , "DATM_CLMNCEP_YR_START" , as.character(site_info$datm_first[isite])
                             , "DATM_CLMNCEP_YR_END"   , as.character(site_info$datm_last [isite])
                             )#end tidyr::tribble
```


The variable below lists all quantities to be updated using the `modify_fates_paramfile.py` functionality of FATES tools.

- In case you do not want to change any settings, set the variable as an empty object (i.e., `prm_settings=NULL`).
- Otherwise, create a tribble object with three string columns, namely `variable`, `pft`, and `value`, corresponding to the trait/parameter to change, the PFT that should be updated (or zero for global parameters), and the value to be updated.

```{r, label='prm-settings'}
prm_settings = tidyr::tribble( ~variable                     , ~pft,    ~value
                             , "fates_phen_drought_threshold",    0, -203943.2
                             , "fates_alloc_storage_cushion" ,    1,       1.2
                             , "fates_alloc_storage_cushion" ,    2,       2.4
                             , "fates_leaf_vcmax25top"       ,    1,  30.94711
                             , "fates_leaf_vcmax25top"       ,    2,  46.42066
                             , "fates_seed_suppl"            ,    1,     0.000
                             , "fates_seed_suppl"            ,    2,     0.000
                             )#end tidyr::tribble
```


Additional settings for the host land model namelist.  This is done in two steps, one to define most variables (`hlm_settings`), and the second to define variables (`hlm_variables`) for the output. Both are defined as tibbles (using `tidyr::tribble`).  Similar to previous structures, `hlm_settings` should have two columns (`variable` and `value`). Both of them should be characters (even if the value should be numeric), and in case the value in ELM-FATES or CLM-FATES should be a character, then use single quotes inside double quotes (e.g., `"'Character Value'"`).

Tibble object `hlm_variables` should be a tribble with the following columns:

- **variable**. The variable name. No need for inside quotes here, but these are **not** case insensitive.
- **fates_only**. Should the variable be included in FATES only simulations
- **add_hlm**. List of host land models for which the variable is available, separated by "+" signs.  Case insensitive. Note that the default list may not reflect which variables are available in the host model. In case the simulation fails to run, check the log files, and remove the host land model from this list.

**Notes**. 

1. For variable names, you can use hlm or HLM as a wild card for the host land model. 
2. Not required, It helps to keep the variables in alphabetical order.

```{r, label='hlm-settings'}
# Additional settings for host land model (EXCEPT variables, see below)
hlm_settings = tidyr::tribble( ~variable          , ~value
                             , "hist_empty_htapes", ".true."
                             , "fates_parteh_mode", "     0"
                             )#end tidyr::tribble

# List of variables to include in the output.
hlm_variable = tidyr::tribble( ~variable                       , ~fates_only, ~add_hlm
                             , "AGB"                           ,        TRUE, "clm+elm"
                             , "AGB_SCPF"                      ,        TRUE, "clm+elm"
                             , "AR"                            ,       FALSE, "clm+elm"
                             , "AR_AGSAPM_SCPF"                ,        TRUE, "clm+elm"
                             , "AR_CROOTM_SCPF"                ,        TRUE, "clm+elm"
                             , "AR_DARKM_SCPF"                 ,        TRUE, "clm+elm"
                             , "AR_FROOTM_SCPF"                ,        TRUE, "clm+elm"
                             , "AR_GROW_SCPF"                  ,        TRUE, "clm+elm"
                             , "AR_SCPF"                       ,        TRUE, "clm+elm"
                             , "BA_SCPF"                       ,        TRUE, "clm+elm"
                             , "BLEAF_CANOPY_SCPF"             ,        TRUE, "clm+elm"
                             , "BLEAF_UNDERSTORY_SCPF"         ,        TRUE, "clm+elm"
                             , "BSTOR_CANOPY_SCPF"             ,        TRUE, "clm+elm"
                             , "BSTOR_UNDERSTORY_SCPF"         ,        TRUE, "clm+elm"
                             , "BTRAN"                         ,       FALSE, "clm+elm"
                             , "BTRANMN"                       ,       FALSE, "clm+elm"
                             , "C_LBLAYER"                     ,        TRUE, "clm+elm"
                             , "C_LBLAYER_BY_AGE"              ,        TRUE, "clm+elm"
                             , "C_STOMATA"                     ,        TRUE, "clm+elm"
                             , "C_STOMATA_BY_AGE"              ,        TRUE, "clm+elm"
                             , "CANOPY_AREA_BY_AGE"            ,        TRUE, "clm+elm"
                             , "CARBON_BALANCE_CANOPY_SCLS"    ,        TRUE, "clm+elm"
                             , "CARBON_BALANCE_UNDERSTORY_SCLS",        TRUE, "clm+elm"
                             , "DDBH_CANOPY_SCPF"              ,        TRUE, "clm+elm"
                             , "DDBH_UNDERSTORY_SCPF"          ,        TRUE, "clm+elm"
                             , "DEMOTION_RATE_SCLS"            ,        TRUE, "clm+elm"
                             , "EFLX_LH_TOT"                   ,       FALSE, "clm+elm"
                             , "ELAI"                          ,       FALSE, "clm+elm"
                             , "ESAI"                          ,       FALSE, "clm+elm"
                             , "FIRE"                          ,       FALSE, "clm+elm"
                             , "FGR"                           ,       FALSE, "clm+elm"
                             , "FLDS"                          ,       FALSE, "clm+elm"
                             , "FSH"                           ,       FALSE, "clm+elm"
                             , "FSH_V"                         ,       FALSE, "clm+elm"
                             , "FSH_G"                         ,       FALSE, "clm+elm"
                             , "FSDS"                          ,       FALSE, "clm+elm"
                             , "FSR"                           ,       FALSE, "clm+elm"
                             , "GPP"                           ,       FALSE, "clm+elm"
                             , "GPP_BY_AGE"                    ,        TRUE, "clm+elm"
                             , "GPP_SCPF"                      ,        TRUE, "clm+elm"
                             , "HR"                            ,       FALSE, "clm+elm"
                             , "LAI_BY_AGE"                    ,        TRUE, "clm+elm"
                             , "LAI_CANOPY_SCPF"               ,        TRUE, "clm+elm"
                             , "LAI_UNDERSTORY_SCPF"           ,        TRUE, "clm+elm"
                             , "M1_SCPF"                       ,        TRUE, "clm+elm"
                             , "M2_SCPF"                       ,        TRUE, "clm+elm"
                             , "M3_SCPF"                       ,        TRUE, "clm+elm"
                             , "M4_SCPF"                       ,        TRUE, "clm+elm"
                             , "M5_SCPF"                       ,        TRUE, "clm+elm"
                             , "M6_SCPF"                       ,        TRUE, "clm+elm"
                             , "M7_SCPF"                       ,        TRUE, "clm+elm"
                             , "M8_SCPF"                       ,        TRUE, "clm+elm"
                             , "M9_SCPF"                       ,        TRUE, "clm+elm"
                             , "M10_SCPF"                      ,        TRUE, "clm+elm"
                             , "MORTALITY_CANOPY_SCPF"         ,        TRUE, "clm+elm"
                             , "MORTALITY_UNDERSTORY_SCPF"     ,        TRUE, "clm+elm"
                             , "NEP"                           ,       FALSE, "clm+elm"
                             , "NPLANT_CANOPY_SCPF"            ,        TRUE, "clm+elm"
                             , "NPLANT_UNDERSTORY_SCPF"        ,        TRUE, "clm+elm"
                             , "NPP_AGDW_SCPF"                 ,        TRUE, "clm+elm"
                             , "NPP_AGSW_SCPF"                 ,        TRUE, "clm+elm"
                             , "NPP_BGDW_SCPF"                 ,        TRUE, "clm+elm"
                             , "NPP_BGSW_SCPF"                 ,        TRUE, "clm+elm"
                             , "NPP_FNRT_SCPF"                 ,        TRUE, "clm+elm"
                             , "NPP_LEAF_SCPF"                 ,        TRUE, "clm+elm"
                             , "NPP_SCPF"                      ,        TRUE, "clm+elm"
                             , "NPP_SEED_SCPF"                 ,        TRUE, "clm+elm"
                             , "NPP_STOR_SCPF"                 ,        TRUE, "clm+elm"
                             , "PATCH_AREA_BY_AGE"             ,        TRUE, "clm+elm"
                             , "PBOT"                          ,       FALSE, "clm+elm"
                             , "PROMOTION_RATE_SCLS"           ,        TRUE, "clm+elm"
                             , "Q2M"                           ,       FALSE, "clm+elm"
                             , "QAF"                           ,        TRUE, "clm+elm"
                             , "QBOT"                          ,       FALSE, "clm+elm"
                             , "QDIRECT_THROUGHFALL"           ,       FALSE, "clm+elm"
                             , "QDRAI"                         ,       FALSE, "clm+elm"
                             , "QDRIP"                         ,       FALSE, "clm+elm"
                             , "QINTR"                         ,       FALSE, "clm+elm"
                             , "QOVER"                         ,       FALSE, "clm+elm"
                             , "QSOIL"                         ,       FALSE, "clm+elm"
                             , "Qtau"                          ,       FALSE, "clm+elm"
                             , "QVEGE"                         ,       FALSE, "clm+elm"
                             , "QVEGT"                         ,       FALSE, "clm+elm"
                             , "RAIN"                          ,       FALSE, "clm+elm"
                             , "SITE_DAYSINCE_DROUGHTLEAFOFF"  ,        TRUE, "clm+elm"
                             , "SITE_DAYSINCE_DROUGHTLEAFON"   ,        TRUE, "clm+elm"
                             , "SITE_DROUGHT_STATUS"           ,        TRUE, "clm+elm"
                             , "SITE_MEANLIQVOL_DROUGHTPHEN"   ,        TRUE, "clm+elm"
                             , "SITE_MEANSMP_DROUGHTPHEN"      ,        TRUE, "clm+elm"
                             , "SMP"                           ,       FALSE, "clm+elm"
                             , "TAF"                           ,       FALSE, "clm+elm"
                             , "TBOT"                          ,       FALSE, "clm+elm"
                             , "TG"                            ,       FALSE, "clm+elm"
                             , "TLAI"                          ,       FALSE, "clm+elm"
                             , "TREFMNAV"                      ,       FALSE, "clm+elm"
                             , "TREFMXAV"                      ,       FALSE, "clm+elm"
                             , "TRIMMING_CANOPY_SCLS"          ,        TRUE, "clm+elm"
                             , "TRIMMING_UNDERSTORY_SCLS"      ,        TRUE, "clm+elm"
                             , "TSA"                           ,       FALSE, "clm+elm"
                             , "TSAI"                          ,       FALSE, "clm+elm"
                             , "TSOI"                          ,        TRUE, "clm+elm"
                             , "TV"                            ,       FALSE, "clm+elm"
                             , "U10"                           ,       FALSE, "clm+elm"
                             , "UAF"                           ,        TRUE, "clm+elm"
                             , "USTAR"                         ,       FALSE, "clm+elm"
                             , "ZWT"                           ,       FALSE, "clm+elm"
                             , "ZWT_PERCH"                     ,       FALSE, "clm+elm"
                             )#end tidyr::tribble
```




# Script execution.

*Important*. Changes beyond this point are needed only for script development.


## Initial settings.

Here the script defines some useful variables, and replace host Earth System Model wildcards with the current host Earth System Model.

```{r, label='set-hesm'}
# Define the host Earth System Model from upper-case CIME_MODEL.
hesm = toupper(hesm)

# Update cade and simulation paths, in case a generic name was provided.
work_path  = gsub(pattern="XXXX",replacement=hesm,x=work_path )
case_root  = gsub(pattern="XXXX",replacement=hesm,x=case_root )
simul_root = gsub(pattern="XXXX",replacement=hesm,x=simul_root)

# Current date.
today = Sys.Date()

# Current path.
here_path = getwd()

# Site path.
site_path = file.path(site_base_path,site_name)
```


Define variables that depend on which host Earth System Model we are using.
```{r, label='set-hesm-variables'}
# Make changes to some of the settings based on the host model.
if ( hesm %in% "E3SM"){
   #--- E3SM-FATES

   # Set CIME model.
   cime_model = "e3sm"

   # Set host land model. Set both upper case and lower case for when needed.
   hlm="elm"
   HLM=toupper(hlm)

   # Main path for host model
   hostmodel_path = dirname(dirname(work_path))

   # Additional options for "create_newcase"
   newcase_opts = ""

   # Main source path for FATES.
   fates_src_path = file.path(hostmodel_path,"components","elm","src","external_models","fates")

   # In case compilation settings are not defined, use the default settings.
   if (comp %in% ""){
      comp = if (use_fates){"IELMFATES"}else{"IELMBGC"}
   }#end if (comp %in% "")

}else if (hesm %in% c("CESM","CTSM")){
   #--- CESM-FATES or CTSM-FATES

   # Set CIME model.
   cime_model = "cesm"

   # Set host land model. Set both upper case and lower case for when needed.
   hlm = "clm"
   HLM = "CLM"

   # Main path for host model
   hostmodel_path = dirname(dirname(work_path))

   # Additional options for "create_newcase"
   newcase_opts = "--run-unsupported"

   # Main source path for FATES.
   fates_src_path = file.path(hostmodel_path,"src","fates")


   # In case compilation settings are not defined, use the default settings.
   if (comp %in% ""){
      comp = if(use_fates){"I2000Clm51Fates"}else{"I2000Clm51Bgc"}
   }#end if (comp %in% "")

}#end if ( hesm %in% "E3SM")
```


Set the host model + FATES Git commit hashes. 
```{r, label='set-git-hash'}
hlm_hash   = paste0(HLM,"-" ,substring(sha(last_commit(repository(hostmodel_path))),1,8))
fates_hash = paste0("FATES-",substring(sha(last_commit(repository(fates_src_path))),1,8))
```


Replace host land model wildcards
```{r, label='set-hlm'}

# Define setting for single-point
v_hlm_usrdat_name=paste0(HLM,"_USRDAT_NAME")

# Substitute wildcards in the resolution with the actual model
resol = gsub(pattern="YYY",replacement=HLM,x=resol)
resol = gsub(pattern="yyy",replacement=hlm,x=resol)
```


Set default case name prefix in case none was provided. Either way, we always append information on host land model and FATES/Big Leaf settings.
We then set up the path containing the case settings (case_path) and the simulation output (simul_path)
```{r, label='set-case-name'}
if (case_prefix %in% "") case_prefix = paste("SX",comp,mach,today,sep="_")

# Append github commit hash, or a simple host-model / FATES tag.
if (use_fates && append_git_hash){
   case_name = paste(case_prefix,hlm_hash,fates_hash,sep="_")
}else if (append_git_hash){
   case_name = paste(case_prefix,hlm_hash,"BigLeaf",sep="_")
}else if (use_fates){
   case_name = paste(case_prefix,HLM,"FATES",sep="_")
}else{
   case_name = paste(case_prefix,HLM,"BigLeaf")
}#end if (use_fates && append_git_hash)

# Set paths for case and simulation.
case_path  = file.path(case_root ,case_name)
simul_path = file.path(simul_root,case_name)

# Set namelist for the host land model.
user_nl_hlm = file.path(case_path,paste0("user_nl_",hlm))

# Set additional namelists
user_nl_datm   = file.path(case_path,"user_nl_datm"  )
user_nl_mosart = file.path(case_path,"user_nl_mosart")

```



To avoid overwriting simulations, we always ask before if it is fine to delete a previous case setting. 
```{r, label='check-owrite-case'}
# Check with user what to do in case directories exist.
if ( dir.exists(case_path) || dir.exists(simul_path) ){
   # In case the user want overwriting, we give them one last chance to cancel before it's too late.
   if (overwrite_case){
      cat("---------------------------------------------------------------------------\n")
      cat("  WARNING! WARNING! WARNING! WARNING! WARNING! WARNING! WARNING! WARNING!  \n")
      cat("  WARNING! WARNING! WARNING! WARNING! WARNING! WARNING! WARNING! WARNING!  \n")
      cat("---------------------------------------------------------------------------\n")
      cat(" One or both case directories already exist, proceeding will delete them.\n")
      cat(" - Case: ",case_path,"  Exists = ",dir.exists(case_path),".\n"         ,sep="")
      cat(" - Simulation: ",simul_path,"  Exists = ",dir.exists(simul_path),".\n" ,sep="")
      cat("\n")
      cat(" I will start deleting files in 5 seconds.\n")
      cat(" In case you change your mind, stop script  before the time is over.\n")
      cat("---------------------------------------------------------------------------\n")
      cnt_down = 6
      for (cnt in sequence(5)){
         cat(" ",6-cnt,"...",sep="")
         dummy = Sys.sleep(time=1)
      }#end for (cnt in sequence(5))
      cat(" Time is over!\n")

      # Delete files
      dummy = unlink(x=case_path ,recursive=TRUE,force=TRUE)
      dummy = unlink(x=simul_path,recursive=TRUE,force=TRUE)

   }else{
      cat(" One or both case directories already exist, cannot procced.\n")
      cat(" - Case: ",case_path,"  Exists = ",dir.exists(case_path),".\n"         ,sep="")
      cat(" - Simulation: ",simul_path,"  Exists = ",dir.exists(simul_path),".\n" ,sep="")
      cat(" Either delete directories, or set \"overwrite_case\" to TRUE.\n")
      stop("Case already exists!")
   }#end if (overwrite_case)
}#end if ( dir.exists(case_path) || dir.exists(simul_path) )

```


## Create case

Create the new case and modify some basic settings.
```{r, label='create-case'}
# Temporarily change path to the working path, then create case.
dummy   = setwd(work_path)
command = paste( "./create_newcase"
               , paste0("--case=",case_path)
               , paste0("--res=",resol)
               , paste0("--compset=",comp)
               , paste0("--mach=",mach)
               , paste0("--project=",project)
               , newcase_opts
               )#end paste
dummy   = system(command=command,intern=TRUE)

# Change working directory to the new case.
dummy = setwd(case_path)

# Set the CIME output to the main CIME path.
dummy = system(paste0("./xmlchange CIME_OUTPUT_ROOT=",simul_root),intern=TRUE)
dummy = system(paste0("./xmlchange DOUT_S_ROOT=",simul_path),intern=TRUE)
dummy = system(paste0("./xmlchange PIO_DEBUG_LEVEL=",debug_level),intern=TRUE)
```


## Modify case

In case this is a user-defined site simulation, set the user-specified paths. 
**Important**. Variable `DATM_MODE` must be set to `CLM1PT`, even when running E3SM-FATES.

```{r, label='set-xml-usrdat'}
# Change working directory to the new case.
dummy = setwd(case_path)

# Set the full name for ATM_DOMAIN_FILE
hlm_usrdat_domain_full = file.path(site_path,hlm_usrdat_domain)

if (resol %in% c("ELM_USRDAT","CLM_USRDAT")){
   dummy = system(paste0("./xmlchange DATM_MODE=\"CLM1PT\"")                          ,intern=TRUE)
   dummy = system(paste0("./xmlchange CALENDAR=\"",metd_calendar,"\"")                ,intern=TRUE)
   dummy = system(paste0("./xmlchange ",v_hlm_usrdat_name,"=\"",site_name,"\"")       ,intern=TRUE)
   dummy = system(paste0("./xmlchange ATM_DOMAIN_PATH=\"",site_path,"\"")             ,intern=TRUE)
   dummy = system(paste0("./xmlchange ATM_DOMAIN_FILE=\"",hlm_usrdat_domain,"\"")     ,intern=TRUE)
   dummy = system(paste0("./xmlchange LND_DOMAIN_PATH=\"",site_path,"\"")             ,intern=TRUE)
   dummy = system(paste0("./xmlchange LND_DOMAIN_FILE=\"",hlm_usrdat_domain,"\"")     ,intern=TRUE)
   dummy = system(paste0("./xmlchange DIN_LOC_ROOT_CLMFORC=\"",site_base_path,"\"")   ,intern=TRUE)
}#end if (resol %in% c("ELM_USRDAT","CLM_USRDAT"))
```


Set the PE layout for a single-site run (unlikely that users would change this).
```{r, label='set-pe-layout'}
# Change working directory to the new case.
dummy = setwd(case_path)

dummy = system(paste0("./xmlchange NTASKS_ATM=1"),intern=TRUE)
dummy = system(paste0("./xmlchange NTASKS_LND=1"),intern=TRUE)
dummy = system(paste0("./xmlchange NTASKS_ROF=1"),intern=TRUE)
dummy = system(paste0("./xmlchange NTASKS_ICE=1"),intern=TRUE)
dummy = system(paste0("./xmlchange NTASKS_OCN=1"),intern=TRUE)
dummy = system(paste0("./xmlchange NTASKS_CPL=1"),intern=TRUE)
dummy = system(paste0("./xmlchange NTASKS_GLC=1"),intern=TRUE)
dummy = system(paste0("./xmlchange NTASKS_WAV=1"),intern=TRUE)
dummy = system(paste0("./xmlchange NTASKS_ESP=1"),intern=TRUE)

dummy = system(paste0("./xmlchange NTHRDS_ATM=1"),intern=TRUE)
dummy = system(paste0("./xmlchange NTHRDS_LND=1"),intern=TRUE)
dummy = system(paste0("./xmlchange NTHRDS_ROF=1"),intern=TRUE)
dummy = system(paste0("./xmlchange NTHRDS_ICE=1"),intern=TRUE)
dummy = system(paste0("./xmlchange NTHRDS_OCN=1"),intern=TRUE)
dummy = system(paste0("./xmlchange NTHRDS_CPL=1"),intern=TRUE)
dummy = system(paste0("./xmlchange NTHRDS_GLC=1"),intern=TRUE)
dummy = system(paste0("./xmlchange NTHRDS_WAV=1"),intern=TRUE)
dummy = system(paste0("./xmlchange NTHRDS_ESP=1"),intern=TRUE)

dummy = system(paste0("./xmlchange ROOTPE_ATM=0"),intern=TRUE)
dummy = system(paste0("./xmlchange ROOTPE_LND=0"),intern=TRUE)
dummy = system(paste0("./xmlchange ROOTPE_ROF=0"),intern=TRUE)
dummy = system(paste0("./xmlchange ROOTPE_ICE=0"),intern=TRUE)
dummy = system(paste0("./xmlchange ROOTPE_OCN=0"),intern=TRUE)
dummy = system(paste0("./xmlchange ROOTPE_CPL=0"),intern=TRUE)
dummy = system(paste0("./xmlchange ROOTPE_GLC=0"),intern=TRUE)
dummy = system(paste0("./xmlchange ROOTPE_WAV=0"),intern=TRUE)
dummy = system(paste0("./xmlchange ROOTPE_ESP=0"),intern=TRUE)
```

Apply the user-specified XML configurations.
```{r, label='set-xlm-user'}
# Change working directory to the new case.
dummy = setwd(case_path)

# Loop through settings, and update entries.
if (is_tibble(xml_settings)){
   cat(" + Update XML settings based on user specifications.\n")
   for (x in sequence(nrow(xml_settings))){
      # Retrieve settings
      xml_id  = xml_settings$variable[x]
      xml_id  = gsub(pattern="YYY",replacement=HLM,xml_id)
      xml_id  = gsub(pattern="yyy",replacement=hlm,xml_id)
      xml_val = xml_settings$value   [x]
      cat("   - ID = ",xml_id,"; VAL = ",xml_val,"\n",sep="")

      # Update settings
      dummy   = system(paste0("./xmlchange ",xml_id,"=\"",xml_val,"\""),intern=TRUE)
   }#end for (x in nrow(xml_settings))
}else if (is.null(xml_settings)){
   cat(" + No XML changes required.\n")
}else{
   stop(" Object \"xml_settings\" must be either a tibble object or NULL.")
}#end if (is_tibble(xml_settings))
```



# Set up the case

Before we set up the case, we may modify a few parameters. First, we update the DATM namelist.



Initial case set up.
```{r, label='case-set-up'}
# Change working directory to the new case.
dummy = setwd(case_path)
cat(" + Set up the case.\n")
dummy = system(paste0("./case.setup"),intern=TRUE)
```



We append the site-specific surface data information to the namelist, in case we are using a single-site simulation. We also append MOSART input files (this did not use to be required, but newer CIME versions are giving error messages).

**Important!**.  Do **NOT** change this unless you know exactly what you are doing.
```{r, label='update-sfc-file'}
if (resol %in% c("ELM_USRDAT","CLM_USRDAT")){
   # Append site-specific surface data information to the namelist.
   hlm_surdat_file = file.path(site_path,hlm_usrdat_surdat)
   dummy           = write( x        = paste0("fsurdat = '",hlm_surdat_file,"'")
                          , file     = user_nl_hlm
                          , ncolumns = 1
                          , append   = TRUE
                          , sep      = ""
                          )#end write  

   # Append time axis mode to the user namelist
   dummy           = write( x        = paste0("taxmode = 'cycle','cycle','cycle'")
                          , file     = user_nl_datm
                          , ncolumns = 1
                          , append   = TRUE
                          , sep      = ""
                          )#end write  

   # Append MOSART input file to the user namelist
   dummy           = write( x        = paste0("frivinp_rtm = ' '")
                          , file     = user_nl_mosart
                          , ncolumns = 1
                          , append   = TRUE
                          , sep      = ""
                          )#end write  
}#end if (resol %in% c("ELM_USRDAT","CLM_USRDAT"))
```


Preview namelists
```{r, label='preview-namelists'}
# Change working directory to the new case.
dummy = setwd(case_path)
cat(" + Preview namelists.\n")
preview_namelists = system(paste0("./preview_namelists"),intern=TRUE)
```


Some meteorological drivers lack incoming longwave irradiance.  If this is the case, we ought to delete it from the list of expected variables. **WARNING**. This is all done automatically, and it's unlikely that users would ever need to change this part.
```{r, label='check-rlong-inp'}
if (resol %in% c("ELM_USRDAT","CLM_USRDAT")){
   # Define files with meteorological driver settings.
   hlm_usrdat_orig=file.path(simul_path,"run",paste0("datm.streams.txt.CLM1PT.",resol))
   hlm_usrdat_user=file.path(simul_path,paste0("user_datm.streams.txt.CLM1PT.",resol))

   # Define meteorological driver path
   datm_path = file.path(site_path,"CLM1PT_data")
   
   # List files
   met_nc_list=list.files(path=datm_path,pattern="^....\\-..\\.nc$",full.names=TRUE)

   if (length(met_nc_list) > 0L){
      # Load one netCDF file.
      met_nc_1st = met_nc_list[1]

      # Get names of all variables in this NetCDF file
      nc_conn = nc_open(met_nc_1st)
      nc_vars = names(nc_conn$var)
      dummy   = nc_close(nc_conn)

      # In case incident longwave radiation is missing, we change the stream file.
      if ("FLDS" %in% nc_vars){
         cat(" + Incoming longwave radiation available from met driver.\n")
      }else{
         cat(" + Remove incoming longwave radiation from met driver.\n")
         dummy = file.copy(from=hlm_usrdat_orig,to=hlm_usrdat_user)
         dummy = system(command=paste0("sed -i '@FLDS@d' ",hlm_usrdat_user),intern=TRUE)
      }#end if (! "FLDS" %in% nc_vars)
   }else{
      # Report error.
      cat(" Meteorological drivers not found in ",datm_path,".\n",sep="")
      cat(" Make sure all the met driver files are named as yyyy-mm.nc\n")
      stop(" Met drivers not found!")
   }#end if (length(any_met_nc) > 0L)
}#end if (resol %in% c("ELM_USRDAT","CLM_USRDAT"))

```


Include settings for the inventory initialisation, in case the user provided a file.
```{r, label='set-finv-init'}
if (use_fates && (! inventory_base %in% "")){
   # Set inventory file.
   cat(" + Append inventory initial conditions to the host land model namelist.\n")
   inventory_file=file.path(site_path,inventory_base)
   

   # Instruct the host land model to use the modified parameter set. 
   dummy = write ( x        =  c( "use_fates_inventory_init = .true."
                                , paste0("fates_inventory_ctrl_filename = '",inventory_file,"'")
                                )#end c
                 , file     =  user_nl_hlm
                 , ncolumns = 1
                 , append   = TRUE
                 , sep      = ""
                 )#end write
}#end if (use_fates && (! inventory_base %in% ""))
```


Create a netCDF parameter file from the cdl file, and modify parameters if required for this specific simulation.
```{r, label='update-pft-params'}
if (use_fates){
   # Identify original parameter file
   if ( fates_params_base %in% ""){
      fates_params_orig = file.path(fates_src_path,"parameter_files","fates_params_default.cdl")
   }else{
      fates_params_orig = file.path(site_path,fates_params_base)
   }#end if ( fates_params_base %in% "")

   # Create a local parameter file
   cat(" + Create local parameter file from ",basename(fates_params_orig),".\n",sep="")
   fates_params_case = file.path(case_path,paste0("fates_params_",case_name,".nc"))
   dummy = system(paste("ncgen -o",fates_params_case,fates_params_orig,sep=" "))

   # Check whether or not to edit parameters
   if ( is_tibble(prm_settings)){
      # Set python script for updating parameters.
      modify_params_py = file.path(fates_src_path,"tools","modify_fates_paramfile.py")

      # Loop through the parameters to update.
      cat(" + Create local parameter file.\n")
      for (p in sequence(nrow(prm_settings))){
         # Retrieve settings.
         prm_var = prm_settings$variable[p]
         prm_pft = prm_settings$pft     [p]
         prm_val = prm_settings$value   [p]

         # Set command to change parameters, skipping PFT in case it is zero.
         if (prm_pft == 0){
            command = paste( modify_params_py
                             , "--var" , prm_var
                             , "--val" , prm_val
                             , "--fin" , fates_params_case
                             , "--fout", fates_params_case
                             , "--O"
                             , sep =" "
            )#end paste
         }else{
            command = paste( modify_params_py
                             , "--var" , prm_var
                             , "--pft" , prm_pft
                             , "--val" , prm_val
                             , "--fin" , fates_params_case
                             , "--fout", fates_params_case
                             , "--O"
                             , sep =" "
            )#end paste
         }#end if (pft_val == 0)

         # Append command
         # dummy  = write(x = command, file = temp_shell, ncolumns = 1, append = TRUE)
         out_mess = system(command=command,intern=TRUE)
         cat("   - ",out_mess[1],".\n",sep="")
      }#end for (p in sequence(nrow(prm_settings)))

      # Instruct the host land model to use the modified parameter set. 
      dummy = write ( x        = paste0("fates_paramfile = '",fates_params_case,"'")
                    , file     = user_nl_hlm
                    , ncolumns = 1
                    , append   = TRUE
                    , sep      = ""
                    )#end write

   }else if (is.null(prm_settings)){
      # No changes needed.
      cat(" + No parameter settings required.\n")
   }else{
      # Incorrect settings.
      stop(" Object \"prm_settings\" must be either a tibble object or NULL.")
   }#end if ( is_tibble(prm_settings))
}else{   
   cat(" + Not a FATES run, skip parameter settings.\n")
}#end if (use_fates)
```


Add other variables to the namelist of the host land model.
```{r, label='update-hlm-settings'}
if (is_tibble(hlm_settings)){
   # Loop through the options to update.
   cat(" + Update host land model settings.\n")

   for (h in sequence(nrow(hlm_settings))){
      # Retrieve settings.
      hlm_id  = hlm_settings$variable[h]
      hlm_val = hlm_settings$value   [h]

      # Check whether or not this is a FATES variable
      is_fates_var = grepl( pattern="fates",ignore.case=TRUE,x=hlm_id)


      #    Check whether this is a FATES variable.  In case it is and USE_FATES is false,
      # we ignore the variable.
      if ( use_fates || (! is_fates_var) ){
         #  Update namelist
         cat("   - Append variable ",hlm_id," = ",hlm_val," to ",basename(user_nl_hlm),".\n",sep="")
         dummy = write( x        = paste0(hlm_id," = ",hlm_val) 
                      , file     = user_nl_hlm
                      , ncolumns = 1
                      , append   = TRUE
                      , sep      = ""
                      )#end write
      }else{
         # Do not update.  Instead, warn the user.
         cat("  - Ignoring ",hlm_id," as this a FATES variable, and use_fates is FALSE.\n")
      }#end if ( use_fates || (! is_fates_var) )
   }#end for (h in sequence(nrow(hlm_settings)))
}else if (is.null(hlm_settings)){
   # No changes needed.
   cat(" + No general HLM namelist settings required.\n")
}else{
   # Incorrect settings.
   stop(" Object \"hlm_settings\" must be either a tibble object or NULL.")
}#end if (is_tibble(hlm_settings))
```


Check whether or not the user provided a list of variables. The code will select them based on whether or not FATES is being called, and whether the host land model is ELM or CLM.
```{r, label = 'update-hlm-variables'}

if (is_tibble(hlm_variable)){

   # Decide which variables to append.
   sel_fates = use_fates | (! hlm_variable$fates_only)
   sel_hlm   = grepl(pattern=hlm,x=hlm_variable$add_hlm)
   sel       = sel_fates & sel_hlm

   # Pool variables to be included, then append it to the nameslist
   hlm_vlist = paste(paste0("'",hlm_variable$variable[sel],"'"),collapse=",")

      
   cat("   - Append list of variables to ",basename(user_nl_hlm),".\n",sep="")
   dummy = write( x        = paste0("hist_fincl1 = ",hlm_vlist) 
                , file     = user_nl_hlm
                , ncolumns = 1
                , append   = TRUE
                , sep      = ""
                )#end write
}else if (is.null(hlm_variable)){
   # No variables needed.  A bit odd, issue a warning.
   warning(" + No HLM-FATES variables required (are you sure about this?).\n")
}else{
   # Incorrect settings.
   stop(" Object \"hlm_variables\" must be either a tibble object or NULL.")
}#end if (is_tibble(hlm_variable))
```




Build the case (and delete previous case run in case it exists). We save the log to verify whether or 
not the case was successfully built, before attempting to run it.
```{r, label='case-build'}
# List of commands for shell
case_shell = c("#!/bin/bash"
              , "if [[ -s \"${HOME}/.bashrc\"       ]]; then . ${HOME}/.bashrc      ; fi"
              , "if [[ -s \"${HOME}/.bash_profile\" ]]; then . ${HOME}/.bash_profile; fi"
              , "if [[ -s \"${HOME}/.profile\"      ]]; then . ${HOME}/.profile     ; fi"
              , paste0("cd ",case_path)
              , "./case.build --clean"
              , "./case.build"
              )#end c

# Create temporary shell
temp_shell = file.path(here_path,"temp_case_shell.sh")
dummy      = write(x=case_shell,file=temp_shell,ncolumns=1,append=FALSE)
dummy      = Sys.chmod(paths=temp_shell,mode="744")

# Run shell
build_log  = system(command=temp_shell,intern=TRUE)

# Delete shell
dummy      = file.remove(temp_shell)

# Verify success
is_success = grepl(pattern = "MODEL BUILD HAS FINISHED SUCCESSFULLY",x=build_log[length(build_log)])

# If case build was unsuccessful, issue an error.
if (! is_success){
   stop(" Case build failed. Check variable \"build_log\" in the R terminal for more information.")
}#end if (! is_success)

```


In case the case building was successful, run the model if the user wants it to be run from within R. Because the simulations may take a while to run, we do not save the output in an internal variable, and do not wait for the simulation to finish.
```{r, label='case-submit'}
# Decide whether or not to submit case.
if (case_submit && case_wait){
   # Run the model, and don't release the terminal until the simulation is finished.
   cat(" + Submit case.  This will take a while to run.\n")
   dummy     = setwd(case_path)
   dummy     = system(command = "./case.submit",wait = TRUE, intern = TRUE)
}else if (case_submit){
   # Run the model.
   cat(" + Submit case.  Note that it will run in the background.\n")
   dummy     = setwd(case_path)
   dummy     = system(command = "./case.submit",wait = FALSE, intern = FALSE)
}else{
   # Write message that the case is ready to submit.
   cat(" + Case is ready to be submitted. You can copy the following to your terminal. \n")
   cat(" (cd ",case_path,"; ./case.submit)\n",sep="")
}#end if (case_submit) 
```
