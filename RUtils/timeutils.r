#==========================================================================================#
#==========================================================================================#
#     Function that checks whether an object is chron.                                     #
#------------------------------------------------------------------------------------------#
is.dates <<- function(x) inherits(x,"dates")
is.times <<- function(x) inherits(x,"times")
is.time  <<- function(x){ is.chron(x) || is.dates(x) || is.times(x)}
#------------------------------------------------------------------------------------------#


#==========================================================================================#
#==========================================================================================#
#      Function that determines whether the year is leap or not.                           #
#------------------------------------------------------------------------------------------#
is.leap <<- function(when){

   wit = is(when)
   
   if ("dates" %in% wit || "chron" %in% wit){
      year = numyears(when)
   }else{
      year = when
   }#end if
   leaptf = year %% 400 == 0 | (year %% 4 == 0 & year %% 100 != 0)
   return(leaptf)
} #end function
#==========================================================================================#
#==========================================================================================#






#==========================================================================================#
#==========================================================================================#
#      Function that determines the number of days in a given month.                       #
#------------------------------------------------------------------------------------------#
daymax <<- function(month,year){
  mmm  = c(31,28,31,30,31,30,31,31,30,31,30,31)

  if (missing(year)){
     wit = is(month)
     if ("dates" %in% wit || "chron" %in% wit){
        when  = month
        year  = numyears (when)
        month = nummonths(when)
     }else{
        stop("  No year given and month is not time")
     }#end if
  }#end if

  mday         = mmm[month]
  addone       = month == 2 & is.leap(year)
  mday[addone] = mday[addone] + 1

  return(mday)
} #end function
#==========================================================================================#
#==========================================================================================#






#==========================================================================================#
#==========================================================================================#
#      Function that converts a chron object to numeric years.                             #
#------------------------------------------------------------------------------------------#
numyears <<- function(when){
   yrs    = years(when)
   lyrs   = levels(yrs)
   yrout  = as.numeric(lyrs[match(yrs,lyrs)])
   return(yrout)
}#end function
#==========================================================================================#
#==========================================================================================#






#==========================================================================================#
#==========================================================================================#
#      Function that converts a chron object to numeric months.                            #
#------------------------------------------------------------------------------------------#
nummonths <<- function(when){
   mos    = months(when)
   lmos   = levels(mos)
   moout  = match(mos,lmos)
   return(moout)
}#end function
#==========================================================================================#
#==========================================================================================#






#==========================================================================================#
#==========================================================================================#
#      Function that converts a chron object to numeric fortnight count.                   #
# Fortnight index goes from 1 to 26, where 1 includes January 1-14, 2 is January 15-28,    #
# and so on.  Some periods get 15 days just to make sure that nothing is lost.             #
#------------------------------------------------------------------------------------------#
numfortnight <<- function(when){
   doy   = floor(dayofyear(when))
   dmax  = 365 + is.leap(when)
   fnfac = dmax / 26
   fnout = ceiling(doy/fnfac)
   return(fnout)
}#end function
#==========================================================================================#
#==========================================================================================#






#==========================================================================================#
#==========================================================================================#
#      Function that converts a chron object to numeric days.                              #
#------------------------------------------------------------------------------------------#
numdays <<- function(when){
   dys    = days(when)
   ldys   = levels(dys)
   dyout  = match(dys,ldys)
   return(dyout)
} #end function
#==========================================================================================#
#==========================================================================================#






#==========================================================================================#
#==========================================================================================#
#      Function that finds the fraction of the day.                                        #
#------------------------------------------------------------------------------------------#
hms2frac <<- function(when){
   thishour  = hours    (when)
   thismin   = minutes  (when)
   thissec   = seconds  (when)

   elapsed = thishour / day.hr + thismin / day.min + thissec / day.sec
   return(elapsed)
}#end function
#==========================================================================================#
#==========================================================================================#






#==========================================================================================#
#==========================================================================================#
#      Function that finds the numeric version of the days.                                #
#------------------------------------------------------------------------------------------#
dayofyear <<- function(when){
   offdays   = c(0, 31,59,90,120,151,181,212,243,273,304,334,365)

   thisday   = numdays  (when)
   thismonth = nummonths(when)
   thisyear  = numyears (when)
   thisfrac  = hms2frac (when)
   
   addone    = as.integer(thismonth > 2 & is.leap(when))

   doy =  thisday + offdays[thismonth] + addone + thisfrac
   return(doy)
} #end function
#==========================================================================================#
#==========================================================================================#
